<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>My ESXi Server | Bruno Blog</title>
<meta name="keywords" content="Homelab">
<meta name="description" content="Index

Introduction
Server Specifications
Backup ESXi Host
Monitoring ESXi

Introduction
Since I joined college I had a need to have more than one operating system available for some classes so I had a few options.
First I could simply run Oracle VM VirtualBox or VMware Workstation Player.
This would work but since I have a ThinkPad X1 Carbon Gen5, it wouldn&rsquo;t handle every ram and cpu usage from the VMs.
The second option would be to buy a new laptop but i didn&rsquo;t want to overuse it.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/2021-07-22-my-esxi-server/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2021-07-22-my-esxi-server/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Bruno Blog (Alt + H)">Bruno Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      My ESXi Server
    </h1>
    <div class="post-meta"><span title='2021-08-21 00:00:00 +0000 UTC'>August 21, 2021</span>&nbsp;·&nbsp;4 min

</div>
  </header> 
  <div class="post-content"><h2 id="index">Index<a hidden class="anchor" aria-hidden="true" href="#index">#</a></h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#hp-z620-specifications">Server Specifications</a></li>
<li><a href="#backup-esxi-host">Backup ESXi Host</a></li>
<li><a href="#monitoring-esxi">Monitoring ESXi</a></li>
</ul>
<h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Since I joined college I had a need to have more than one operating system available for some classes so I had a few options.</p>
<p>First I could simply run <a href="https://www.virtualbox.org/">Oracle VM VirtualBox</a> or <a href="https://www.vmware.com/products/workstation-player.html">VMware Workstation Player</a>.
This would work but since I have a ThinkPad X1 Carbon Gen5, it wouldn&rsquo;t handle every ram and cpu usage from the VMs.</p>
<p>The second option would be to buy a new laptop but i didn&rsquo;t want to overuse it.</p>
<p>So the third option, the one I choosed, was to buy a refurbished server and install <a href="https://www.vmware.com/products/esxi-and-esx.html">ESXi</a> or <a href="https://proxmox.com/en/">Proxmox</a> creating
a virtualization server giving more lifetime to the laptop.</p>
<p>After looking for a few weeks, I found <a href="https://www.bargainhardware.co.uk/">Bargain Hardware</a>. Bargain Hardware is an awesome website with realy cool prices.
I was looking for a Dell product after reading Reddit&rsquo;s reviews but I only found rack servers and a rack server would not fit since I
dont have a rack. So I moved to HP products and found HP Z620. Two weeks have passed by and the server had arrived.</p>
<h2 id="hp-z620-specifications">HP Z620 Specifications<a hidden class="anchor" aria-hidden="true" href="#hp-z620-specifications">#</a></h2>
<table>
  <thead>
      <tr>
          <th>Hardware</th>
          <th>Brand</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CPU</td>
          <td><a href="https://ark.intel.com/content/www/us/en/ark/products/series/59138/intel-xeon-processor-e5-family.html">2x Xeon E5-2670 2.60GHz Eight 8-Core</a></td>
      </tr>
      <tr>
          <td>RAM</td>
          <td>24 GB RAM 1600MHz Kingston</td>
      </tr>
      <tr>
          <td>GPU</td>
          <td>ATI Radeon HD-3470 256 MB GDDR2</td>
      </tr>
  </tbody>
</table>
<p>I added two Western Digital 500 GB HDDs and one Samsung Evo 500 GB SSD that I had in another workstation.</p>
<p>Then I needed to choose between ESXi or Proxmox. After reading some tips from a few forums I choosed ESXi for two reasons. First I could run ESXi from
a usb stick since ESXi OS goes to RAM on boot making almost no read/writes into the usb stick and the second reason was that VMware is well known and has a bigger community making easier to find
help online.</p>
<figure class="post-image">
    <img loading="lazy" src="/my_esxi_server/esxi_server.jpeg"/> 
</figure>

<p>Then I had to see if the hardware of the server was compatible with ESXi, and it wasn&rsquo;t (NIC was not compatible) but then I found some <a href="https://rodrigolira.eti.br/isos-esxi-customizadas/">custom ESXi ISOs</a>. The next step was to make a bootable usb using the custom iso and for that I used <a href="https://www.balena.io/etcher/">etcher</a>.</p>
<p>ESXi boots up and the only thing I needed to change was the ip address and make sure the NIC was working properly with the custom iso (I could see the NIC was working because it reached my home router).</p>
<p>After making that, the server was up and running like a charm and the next step was to create some VMs.</p>
<figure class="post-80-image">
    <img loading="lazy" src="/my_esxi_server/esxi_gui.png"/> 
</figure>

<h2 id="backup-esxi-host">Backup ESXi Host<a hidden class="anchor" aria-hidden="true" href="#backup-esxi-host">#</a></h2>
<p>Having healthy ESXi hosts is a key to success when running virtual machines. That’s why it is better to back up ESXi configuration. Thus, if something goes wrong with an ESXi host, its configuration can be restored in a few minutes without spending a lot of time to configure an ESXi server from scratch.</p>
<h3 id="using-esxi-command-line-to-backup-esxi-host">Using ESXi Command Line To Backup ESXi Host<a hidden class="anchor" aria-hidden="true" href="#using-esxi-command-line-to-backup-esxi-host">#</a></h3>
<p>ESXi configuration is saved every hour automatically to the <strong>/bootblank/state.tgz</strong> file. So I needed to run two commands, one to do the backup and the other one to get a link to the specific backup.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim-cmd hostsvc/firmware/sync_config
</span></span><span style="display:flex;"><span>vim-cmd hostsvc/firmware/backup_config
</span></span></code></pre></div><p>Then I downloaded the <strong>tgz</strong> file stored in <strong>/scratch/downloads</strong>.</p>
<h3 id="automate-the-backup">Automate The Backup<a hidden class="anchor" aria-hidden="true" href="#automate-the-backup">#</a></h3>
<h4 id="create-a-directory-to-store-backup-files-on-your-esxi-datastore">Create a directory to store backup files on your ESXi datastore<a hidden class="anchor" aria-hidden="true" href="#create-a-directory-to-store-backup-files-on-your-esxi-datastore">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /vmfs/volumes/datastore1/ESXi_backup
</span></span></code></pre></div><h4 id="create-a-script-to-backup-esxi-configuration">Create a script to backup ESXi configuration<a hidden class="anchor" aria-hidden="true" href="#create-a-script-to-backup-esxi-configuration">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /vmfs/volumes/datastore1/ESXi_backup/esxi_backup.sh
</span></span></code></pre></div><h4 id="add-the-following-lines-to-the-script">Add the following lines to the script<a hidden class="anchor" aria-hidden="true" href="#add-the-following-lines-to-the-script">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim-cmd hostsvc/firmware/sync_config
</span></span><span style="display:flex;"><span>vim-cmd hostsvc/firmware/backup_config
</span></span><span style="display:flex;"><span>find /scratch/downloads/ -name <span style="color:#cb4b16">\*</span>.tgz -exec cp <span style="color:#719e07">{}</span> /vmfs/volumes/datastore1/ESXi_backup/ESXi_config_backup_<span style="color:#719e07">$(</span>date +<span style="color:#2aa198">&#39;%Y%m%d_%H%M%S&#39;</span><span style="color:#719e07">)</span>.tgz <span style="color:#cb4b16">\;</span>
</span></span></code></pre></div><h4 id="make-the-script-executable">Make the script executable<a hidden class="anchor" aria-hidden="true" href="#make-the-script-executable">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x /vmfs/volumes/datastore1/ESXi_backup/esxi_backup.sh
</span></span></code></pre></div><h4 id="run-the-script">Run the script<a hidden class="anchor" aria-hidden="true" href="#run-the-script">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#b58900">cd</span> /vmfs/volumes/datastore1/ESXi_backup/
</span></span><span style="display:flex;"><span>./esxi_backup.sh
</span></span></code></pre></div><figure class="post-80-image">
    <img loading="lazy" src="/my_esxi_server/esxi_1.png"/> 
</figure>

<h4 id="edit-scheduler-to-make-sure-the-backup-esxi-host-script-is-running-automatically">Edit scheduler to make sure the backup ESXi host script is running automatically<a hidden class="anchor" aria-hidden="true" href="#edit-scheduler-to-make-sure-the-backup-esxi-host-script-is-running-automatically">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /var/spool/cron/crontabs/root
</span></span></code></pre></div><h4 id="add-the-following-string-to-backup-everyday-at-0210-am-and-save-the-changes">Add the following string to backup everyday at 02:10 AM and save the changes<a hidden class="anchor" aria-hidden="true" href="#add-the-following-string-to-backup-everyday-at-0210-am-and-save-the-changes">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#2aa198">10</span> <span style="color:#2aa198">02</span> * * * /vmfs/volumes/datastore1/ESXi_backup/esxi_backup.sh
</span></span></code></pre></div><h2 id="monitoring-esxi">Monitoring ESXi<a hidden class="anchor" aria-hidden="true" href="#monitoring-esxi">#</a></h2>
<p>Even having a nice UI in VMware ESXi Web Interface I had to monitor ESXi outside of my LAN and, for security reasons, I didn&rsquo;t want to make the server public to the WAN so I made a python script to help me on that job. The script can be find on my <a href="https://github.com/BrunoTeixeira1996/TelegramBot/blob/main/src/modules/esxi.py">TelegramBot repository</a>.</p>
<figure class="post-80-image">
    <img loading="lazy" src="/my_esxi_server/esxi_monitor.jpg"/> 
</figure>

<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://www.vmware.com/products/esxi-and-esx.html">https://www.vmware.com/products/esxi-and-esx.html</a></li>
<li><a href="https://www.pendrivelinux.com/etcher-usb-iso-burner-and-clone-tool/">https://www.pendrivelinux.com/etcher-usb-iso-burner-and-clone-tool/</a></li>
<li><a href="https://www.bargainhardware.co.uk/">https://www.bargainhardware.co.uk/</a></li>
<li><a href="http://www.fabfile.org/">http://www.fabfile.org/</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/homelab/">Homelab</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Bruno Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
